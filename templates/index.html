<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Secure Cloud Storage</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin:0; padding:0;}
        .container { max-width:800px; margin:50px auto; background:#fff; padding:40px; border-radius:15px; box-shadow:0 8px 25px rgba(0,0,0,0.15);}
        h1 {text-align:center; margin-bottom:30px;}
        input[type="file"], input[type="text"] {padding:12px; margin-right:10px; width:calc(100%-160px); border-radius:8px; border:1px solid #ddd;}
        button {padding:12px 20px; border-radius:8px; border:none; cursor:pointer; margin-bottom:10px;}
        .btn-primary {background:#3498db;color:#fff;}
        .btn-success {background:#2ecc71;color:#fff;}
        .btn-refresh {background:#f39c12;color:#fff;}
        ul {list-style:none;padding:0;}
        li {display:flex;justify-content:space-between;background:#ecf0f1;padding:12px;border-radius:8px;margin-bottom:8px;}
    </style>
</head>
<body>
<div class="container">
    <h1>Secure Cloud Storage</h1>

    <h2>Upload File (Client-side Encrypted)</h2>
    <div style="display:flex; flex-wrap:wrap;">
        <input type="file" id="uploadFile">
        <input type="text" id="encryptionKey" placeholder="Encryption key">
        <button class="btn-primary" onclick="uploadFile()">Upload</button>
    </div>
    <p id="uploadResult"></p>

    <h2>Files in Bucket</h2>
    <button class="btn-refresh" onclick="listFiles()">Refresh File List</button>
    <ul id="fileList"></ul>
</div>

<script>
const HEADER = "SECURECLOUD::";

async function uploadFile() {
    const fileInput = document.getElementById("uploadFile");
    const keyInput = document.getElementById("encryptionKey");
    const file = fileInput.files[0];
    const key = keyInput.value.trim();
    if (!file || !key) { alert("Select file and enter key!"); return; }

    const arrayBuffer = await file.arrayBuffer();
    const wordArray = CryptoJS.lib.WordArray.create(arrayBuffer);
    const base64Data = CryptoJS.enc.Base64.stringify(wordArray);
    const toEncrypt = HEADER + base64Data;
    const encrypted = CryptoJS.AES.encrypt(toEncrypt, key).toString();
    const blob = new Blob([encrypted], { type: "text/plain" });

    const formData = new FormData();
    formData.append("file", blob, file.name + ".enc");

    try {
        const res = await fetch("/upload", { method:"POST", body:formData });
        const data = await res.json();
        document.getElementById("uploadResult").innerText = data.error ? "❌ "+data.error : data.message;
        listFiles();
        fileInput.value=""; keyInput.value="";
    } catch(err) {
        alert("❌ Upload failed: "+err.message);
    }
}

async function listFiles() {
    try {
        const res = await fetch("/list-files");
        const data = await res.json();
        const ul = document.getElementById("fileList"); ul.innerHTML="";
        if(data.error){ ul.innerHTML=`<li style="color:red">${data.error}</li>`; return; }
        if(!data.files || data.files.length===0){ ul.innerHTML="<li>No files found.</li>"; return; }
        data.files.forEach(file=>{
            const li=document.createElement("li"); li.textContent=file;
            const btn=document.createElement("button");
            btn.className="btn-success"; btn.textContent="Download & Decrypt";
            btn.onclick=()=>downloadFile(file);
            li.appendChild(btn); ul.appendChild(li);
        });
    } catch(err){ alert("Failed to load files: "+err.message); }
}

async function downloadFile(fileName){
    const key = prompt("Enter encryption key:");
    if(!key) return;
    try{
        const res = await fetch("/download",{ method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({file_name:fileName}) });
        const data = await res.json();
        if(data.error){ alert("Error: "+data.error); return; }

        const encryptedText = atob(data.encrypted_content); // Base64 decode
        const decrypted = CryptoJS.AES.decrypt(encryptedText, key);
        const utf8 = decrypted.toString(CryptoJS.enc.Utf8);

        if(!utf8.startsWith(HEADER)){ alert("❌ Wrong key!"); return; }

        const base64Data = utf8.slice(HEADER.length);
        const bytes = Uint8Array.from(atob(base64Data), c=>c.charCodeAt(0));
        const blob = new Blob([bytes]);
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a"); a.href=url; a.download=fileName.replace(".enc","");
        document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);

        alert("✅ File downloaded successfully!");
    } catch(err){ alert("❌ Download failed: "+err.message); }
}

window.onload = listFiles;
</script>
</body>
</html>
